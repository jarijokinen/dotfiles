#!/bin/bash

set -e

pre_install_packages="
  locales
"

exclude_packages="
  apt-utils
  blends-tasks
  bsdmainutils
  debconf-i18n
  nano
  tasksel
  tasksel-data
  vim-tiny
"

base_packages="
"

x_packages="
  chromium
  evince
  geeqie
  gimp
  gnome-backgrounds
  gnome-icon-theme-symbolic
  inkscape
  keepassx
  libgl1-mesa-dri
  libpango1.0-0
  libreoffice-style-tango
  libreoffice-writer
  lightdm
  lsb-release
  pavucontrol
  pepperflashplugin-nonfree
  policykit-1
  pulseaudio
  ttf-mscorefonts-installer
  x11-utils
  x11-xkb-utils
  x11-xserver-utils
  xfce4-panel
  xfce4-pulseaudio-plugin
  xfce4-screenshooter
  xfce4-session
  xfdesktop4
  xfonts-100dpi
  xfonts-scalable
  xfonts-terminus
  xfonts-terminus-oblique
  xfwm4
  xkb-data
  xserver-xorg-core
  xserver-xorg-input-evdev
  xterm
"

wifi_packages="
  firmware-iwlwifi
  wireless-tools
  wpasupplicant
"

rvm_packages="
  autoconf
  automake
  bison
  gawk
  libffi-dev
  libgdbm-dev
  libgmp-dev
  libncurses5-dev
  libreadline6-dev
  libsqlite3-dev
  libtool
  libyaml-dev
  pkg-config 
  sqlite3
"

gcc_packages="
  gcc
  make
"

rails_packages="
  libgmp-dev
  libsqlite3-dev
  zlib1g-dev
"

nginx_packages="
  libpcre3-dev
  libssl-dev
"

php_packages="
  libcurl4-openssl-dev
  libxml2-dev
  zlib1g-dev
"

wordpress_packages="
  libjpeg-dev
  libmcrypt-dev
  libpng-dev
  mariadb-server
"

backport_packages="
  certbot
  libssl-dev
"

case "$1" in
  desktop)
    packages="
      $base_packages
      $gcc_packages
      $rvm_packages
      $rails_packages
      $x_packages
      anacron
      archivemail
      console-setup
      curl
      dnsutils
      fakeroot
      git
      grub-pc
      initramfs-tools
      irqbalance
      kernel-package
      libsasl2-modules
      linux-image-amd64
      mutt
      openssh-client
      screen
      unzip
      vim-nox
      whois
    "
  ;;

  laptop)
    packages="
      $base_packages
      $gcc_packages
      $rvm_packages
      $rails_packages
      $x_packages
      $wifi_packages
      anacron
      archivemail
      console-setup
      curl
      dnsutils
      fakeroot
      git
      grub-pc
      initramfs-tools
      irqbalance
      kernel-package
      libsasl2-modules
      linux-image-amd64
      mutt
      openssh-client
      screen
      unzip
      vim-nox
      whois
    "
  ;;

  upcloud_wordpress)
    packages="
      $base_packages
      $gcc_packages
      $nginx_packages
      $php_packages
      $wordpress_packages
      console-setup
      cron
      curl
      git
      grub-pc
      initramfs-tools
      linux-image-amd64
      openssh-server
      postfix
      vim-nox
    "
  ;;

  *)
    echo "Usage: build_jessie PROFILE"
    echo "Available profiles: desktop laptop upcloud_wordpress"
    exit -1
  ;;
esac

arch="amd64"
suite="jessie"
components="main,contrib,non-free"
mirror="http://ftp.debian.org/debian"
image_version=`date +"%Y-%m-%d-%s"`
target="/root/$suite-image-$image_version"

dropbox_package_url="https://www.dropbox.com/download?dl=packages/debian/\
dropbox_2015.10.28_amd64.deb"

export LANG="C.UTF-8"

msg() { echo "$1"; }
err() { msg "E: $1"; exit 1; }

[[ $EUID -eq 0 ]] || err "this script must be run as root."

msg "Downloading the system..."
pre_install_packages=$(echo $pre_install_packages | tr ' ' ,)
exclude_packages=$(echo $exclude_packages | tr ' ' ,)
debootstrap --arch=$arch --components=$components --exclude=$exclude_packages \
  --include=$pre_install_packages $suite $target $mirror

msg "Mounting devices..."
mount --bind --make-rslave /dev $target/dev
mount --bind --make-rslave /sys $target/sys
mount --bind --make-rslave /proc $target/proc

msg "Configuring apt..."
components=${components//,/ }
cat << EOF > $target/etc/apt/sources.list
deb $mirror $suite $components
deb $mirror $suite-updates $components
deb $mirror $suite-backports $components
deb http://security.debian.org/ $suite/updates $components
EOF
echo 'APT::Install-Recommends "0";' > $target/etc/apt/apt.conf.d/01recommends
chroot $target apt update
chroot $target apt dist-upgrade

msg "Configuring settings..."
chroot $target dpkg-reconfigure locales
chroot $target dpkg-reconfigure debconf
chroot $target dpkg-reconfigure tzdata

msg "Installing packages..."
chroot $target apt -t ${suite}-backports install $backport_packages
chroot $target apt install $packages

case "$1" in
  desktop)
    msg "Installing Dropbox..."
    wget -O $target/tmp/dropbox.deb $dropbox_package_url
    chroot $target dpkg -i /tmp/dropbox.deb
  ;;
  laptop)
    msg "Installing Dropbox..."
    wget -O $target/tmp/dropbox.deb $dropbox_package_url
    chroot $target dpkg -i /tmp/dropbox.deb
  ;;
esac

case "$1" in
  laptop)
    msg "Configuring touchpad..."
    mkdir -p $target/etc/X11/xorg.conf.d
    cat << EOF > $target/etc/X11/xorg.conf.d/30-touchpad.conf
Section "InputClass"
        Identifier "touchpad"
        MatchProduct "DLL0665:01 06CB:76AD Touchpad"
        Driver "libinput"
        Option "Tapping" "on"
        Option "AccelSpeed" "0.5"
EndSection
EOF
    chroot $target apt update
    chroot $target apt install dropbox
  ;;
esac

msg "Configuring network..."
case "$1" in
  desktop)
    cat << EOF > $target/etc/network/interfaces.d/eth0
auto eth0
iface eth0 inet dhcp
EOF
  ;;
  laptop)
    read -p "WLAN SSID: " wpa_ssid
    read -p "WLAN Password: " wpa_psk
    cat << EOF > $target/etc/network/interfaces.d/wlan0
auto wlan0
iface wlan0 inet dhcp
  wpa-ssid $wpa_ssid
  wpa-psk $wpa_psk
EOF
  ;;
  upcloud_wordpress)
    cat << EOF > $target/etc/network/interfaces.d/eth0
auto eth0
iface eth0 inet dhcp
EOF
    cat << EOF > $target/etc/network/interfaces.d/eth1
auto eth1
iface eth1 inet dhcp
EOF
    cat << EOF > $target/etc/network/interfaces.d/eth2
auto eth2
iface eth2 inet6 dhcp
EOF
  ;;
esac

msg "Configuring grub..."
sed -i 's/GRUB_TIMEOUT=5/GRUB_TIMEOUT=1/g' $target/etc/default/grub
chroot $target update-grub

msg "Setting up root password..."
chroot $target passwd

msg "Unmounting devices..."
umount -l $target/dev
umount -l $target/sys
umount -l $target/proc

msg "Removing packages..."
rm -rf $target/var/cache/apt/archives/*.deb

exit 0
