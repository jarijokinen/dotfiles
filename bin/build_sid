#!/bin/bash

set -e

packages="
"

pre_install_packages="
  locales
"

exclude_packages="
  apt-utils
  blends-tasks
  bsdmainutils
  debconf-i18n
  nano
  tasksel
  tasksel-data
  vim-tiny
"

case "$1" in
  desktop)
    packages="
      $packages
      anacron
      archivemail
      chromium
      console-setup
      curl
      dnsutils
      evince
      geeqie
      gimp
      git
      gnome-backgrounds
      gnome-icon-theme-symbolic
      grub-pc
      initramfs-tools
      inkscape
      irqbalance
      keepassx
      kernel-package
      libgl1-mesa-dri
      libreoffice-style-tango
      libreoffice-writer
      libsasl2-modules
      lightdm
      linux-image-amd64
      mutt
      openssh-client
      pavucontrol
      pepperflashplugin-nonfree
      policykit-1
      pulseaudio
      screen
      ttf-mscorefonts-installer
      vim-nox
      whois
      x11-utils
      xfce4-panel
      xfce4-pulseaudio-plugin
      xfce4-screenshooter
      xfce4-session
      xfdesktop4
      xfonts-100dpi
      xfonts-scalable
      xfonts-terminus
      xfonts-terminus-oblique
      xfwm4
      xkb-data
      x11-xkb-utils
      x11-xserver-utils
      xserver-xorg-core
      xserver-xorg-input-evdev
      xterm
    "
  ;;

  laptop)
    packages="
      $packages
      anacron
      archivemail
      chromium
      console-setup
      curl
      dnsutils
      evince
      geeqie
      gimp
      git
      gnome-backgrounds
      gnome-icon-theme-symbolic
      grub-pc
      initramfs-tools
      inkscape
      irqbalance
      keepassx
      kernel-package
      libgl1-mesa-dri
      libreoffice-style-tango
      libreoffice-writer
      libsasl2-modules
      lightdm
      linux-image-amd64
      mutt
      openssh-client
      pavucontrol
      pepperflashplugin-nonfree
      policykit-1
      pulseaudio
      screen
      ttf-mscorefonts-installer
      vim-nox
      whois
      wireless-tools
      wpasupplicant
      x11-utils
      xfce4-battery-plugin
      xfce4-panel
      xfce4-pulseaudio-plugin
      xfce4-screenshooter
      xfce4-session
      xfdesktop4
      xfonts-100dpi
      xfonts-scalable
      xfonts-terminus
      xfonts-terminus-oblique
      xfwm4
      xkb-data
      x11-xkb-utils
      x11-xserver-utils
      xserver-xorg-core
      xserver-xorg-input-synaptics
      xterm
    "
  ;;

  vps)
    packages="
      $packages
    "
  ;;

  *)
    echo "Usage: build_sid PROFILE"
    echo "Available profiles: desktop laptop vps"
    exit -1
  ;;
esac

arch="amd64"
suite="sid"
components="main,contrib,non-free"
mirror="http://ftp.debian.org/debian"
image_version=`date +"%Y-%m-%d-%s"`
target="/root/$suite-image-$image_version"

export LANG="C.UTF-8"

msg() { echo "$1"; }
err() { msg "E: $1"; exit 1; }

[[ $EUID -eq 0 ]] || err "this script must be run as root."

msg "Downloading the system..."
pre_install_packages=$(echo $pre_install_packages | tr ' ' ,)
exclude_packages=$(echo $exclude_packages | tr ' ' ,)
debootstrap --arch=$arch --components=$components --exclude=$exclude_packages \
  --include=$pre_install_packages $suite $target $mirror

msg "Mounting devices..."
mount --bind --make-rslave /dev $target/dev
mount --bind --make-rslave /sys $target/sys
mount --bind --make-rslave /proc $target/proc

msg "Configuring apt..."
components=${components//,/ }
cat << EOF > $target/etc/apt/sources.list
deb $mirror $suite $components
EOF
echo 'APT::Install-Recommends "0";' > $target/etc/apt/apt.conf.d/01recommends
chroot $target apt-get update
chroot $target apt-get dist-upgrade

msg "Configuring settings..."
chroot $target dpkg-reconfigure locales
chroot $target dpkg-reconfigure debconf
chroot $target dpkg-reconfigure tzdata

msg "Installing packages..."
chroot $target apt-get install $packages

msg "Configuring network..."
case "$1" in
  desktop)
    cat << EOF > $target/etc/network/interfaces.d/enp3s0
auto enp3s0
iface enp3s0 inet dhcp
EOF
  ;;
  laptop)
    read -p "WLAN SSID: " wpa_ssid
    read -p "WLAN Password: " wpa_psk
    cat << EOF > $target/etc/network/interfaces.d/wlp3s0
auto wlp3s0
iface wlp3s0 inet dhcp
  wpa-ssid $wpa_ssid
  wpa-psk $wpa_psk
EOF
  ;;
esac

msg "Configuring grub..."
sed -i 's/GRUB_TIMEOUT=5/GRUB_TIMEOUT=1/g' $target/etc/default/grub
chroot $target update-grub

msg "Setting up root password..."
chroot $target passwd

msg "Unmounting devices..."
umount -l $target/dev
umount -l $target/sys
umount -l $target/proc

msg "Removing packages..."
rm -rf $target/var/cache/apt/archives/*.deb

exit 0
