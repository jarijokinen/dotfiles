#!/bin/sh

ipt() {
  /sbin/iptables "$@"
  /sbin/ip6tables "$@"
}

# Default rules

ipt -F
ipt -P INPUT DROP
ipt -P OUTPUT DROP
ipt -P FORWARD DROP

# Local loopback

ipt -A OUTPUT -o lo -j ACCEPT
ipt -A INPUT -i lo -j ACCEPT

## CLIENTS

# DNS client

ipt -A OUTPUT -p udp --dport 53 -m state --state NEW,ESTABLISHED -j ACCEPT
ipt -A INPUT -p udp --sport 53 -m state --state ESTABLISHED -j ACCEPT

# NTP client

ipt -A OUTPUT -p udp --sport 123 -m state --state NEW,ESTABLISHED -j ACCEPT
ipt -A INPUT -p udp --dport 123 -m state --state ESTABLISHED -j ACCEPT

# SSH client

ipt -A OUTPUT -p tcp --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT
ipt -A INPUT -p tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT

# HTTP client

ipt -A OUTPUT -p tcp --dport 80 -m state --state NEW,ESTABLISHED -j ACCEPT
ipt -A INPUT -p tcp --sport 80 -m state --state ESTABLISHED -j ACCEPT

# HTTPS client

ipt -A OUTPUT -p tcp --dport 443 -m state --state NEW,ESTABLISHED -j ACCEPT
ipt -A INPUT -p tcp --sport 443 -m state --state ESTABLISHED -j ACCEPT

# Git client

ipt -A OUTPUT -p tcp --dport 9418 -m state --state NEW,ESTABLISHED -j ACCEPT
ipt -A INPUT -p tcp --sport 9418 -m state --state ESTABLISHED -j ACCEPT

# OpenPGP HTTP client

ipt -A OUTPUT -p tcp --dport 11371 -m state --state NEW,ESTABLISHED -j ACCEPT
ipt -A INPUT -p tcp --sport 11371 -m state --state ESTABLISHED -j ACCEPT

## SERVERS

# SSH server

ipt -A INPUT -p tcp --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT
ipt -A OUTPUT -p tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT

# Logging

ipt -A INPUT -j LOG --log-level info
ipt -A OUTPUT -j LOG --log-level info
ipt -A FORWARD -j LOG --log-level info

exit 0
