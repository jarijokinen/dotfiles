#!/bin/bash

set -e

src_path=$HOME/src
package_path=$HOME/nodejs

[[ -d "$src_path" ]] || mkdir -p $src_path

package_url=$(
  curl -s https://nodejs.org/en/download/current/ | grep .tar.gz \
  | grep -oP 'https://nodejs.org/dist/.+?/node.+?.tar.gz' | head -1
)

package_archive=$(echo ${package_url##*/})
package_version=$(echo $package_archive | cut -d . -f -3 | cut -d - -f 2)
echo "Latest version is $package_version"

if [[ -x "$package_path/bin/node" ]]; then
  installed=1
  installed_version=$($package_path/bin/node -v)
  echo "Installed version is $installed_version"
else
  installed=0
  echo "Not installed"
fi

configure_options="--prefix=$package_path"

if [[ $installed == 0 ]] || [[ $package_version != $installed_version ]]; then
  echo "Updating..."
  if [[ ! -d "$src_path/node-$package_version" ]]; then
    if [[ ! -f "$src_path/$package_archive" ]]; then
      wget $package_url -O $src_path/$package_archive
    fi
    tar -xf $src_path/$package_archive -C $src_path
  fi

  cd $src_path/node-$package_version
  ./configure $configure_options
  make
  make install
  [[ -e $HOME/.bin/node ]] || ln -s $package_path/bin/node $HOME/.bin/node
  [[ -e $HOME/.bin/npm ]]  || ln -s $package_path/bin/npm $HOME/.bin/npm
  npm -g install bower
  npm -g install grunt-cli
  npm -g install gulp-cli
  npm -g install yo
  npm -g install express
  npm -g install express-generator
  npm -g install sails
fi

if [[ $installed == 1 ]]; then
  [[ -e $HOME/.bin/node ]]    || ln -s $package_path/bin/node $HOME/.bin/node
  [[ -e $HOME/.bin/npm ]]     || ln -s $package_path/bin/npm $HOME/.bin/npm
  [[ -e $HOME/.bin/bower ]]   || ln -s $package_path/bin/bower $HOME/.bin/bower
  [[ -e $HOME/.bin/grunt ]]   || ln -s $package_path/bin/grunt $HOME/.bin/grunt
  [[ -e $HOME/.bin/gulp ]]    || ln -s $package_path/bin/gulp $HOME/.bin/gulp
  [[ -e $HOME/.bin/yo ]]      || ln -s $package_path/bin/yo $HOME/.bin/yo
  [[ -e $HOME/.bin/express ]] || ln -s $package_path/bin/express $HOME/.bin/express
  [[ -e $HOME/.bin/sails ]]   || ln -s $package_path/bin/sails $HOME/.bin/sails
  npm -g update
fi

exit 0
