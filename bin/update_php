#!/bin/bash

set -e

wordpress_support=0

if [[ $1 == 'wordpress' ]]; then
  wordpress_support=1
fi

src_path=$HOME/src
package_path=$HOME/php

package_url="https://php.net$(
  curl -s http://php.net/downloads.php | grep .tar.gz \
  | grep -oP '/get/php.+?.tar.gz' | head -1
)"
package_archive=$(echo ${package_url##*/})
package_version=$(echo $package_archive | cut -d . -f -3 | cut -d - -f 2)
echo "Latest version is $package_version"

if [[ -x "$package_path/sbin/php-fpm" ]]; then
  installed=1
  installed_version=$($package_path/sbin/php-fpm -v | head -1 | cut -d " " -f2)
  configure_options=$($package_path/bin/php -i | grep Configure | \
    cut -d " " -f6- | tr -d "'")
  echo "Installed version is $installed_version"
else
  echo "Not installed"
  installed=0
  
  echo "Checking required packages..."
  su -c "apt install gcc make libcurl4-openssl-dev libxml2-dev zlib1g-dev \
    libjpeg-dev libmcrypt-dev libpng-dev"

  configure_options="
    --prefix=$package_path
    --enable-fpm
    --with-curl
    --with-mysql-sock=/var/run/mysqld/mysqld.sock
    --with-mysqli
    --with-openssl
    --with-zlib
  "

  if [[ $wordpress_support == 1 ]]; then
    configure_options="
      --prefix=$package_path
      --enable-fpm
      --enable-mbstring
      --with-curl
      --with-gd
      --with-jpeg-dir=/usr/lib/x86_64-linux-gnu
      --with-mcrypt
      --with-mysql-sock=/var/run/mysqld/mysqld.sock
      --with-mysqli
      --with-zlib
    "
  fi
fi

if [[ $installed == 0 ]] || [[ $package_version != $installed_version ]]; then
  echo "Updating..."
  [[ -d "$src_path" ]] || mkdir -p $src_path
  if [[ ! -d "$src_path/php-$package_version" ]]; then
    if [[ ! -f "$src_path/$package_archive" ]]; then
      wget $package_url/from/this/mirror -O $src_path/$package_archive
    fi
    tar -xf $src_path/$package_archive -C $src_path
  fi
  cd $src_path/php-$package_version
  ./configure $configure_options
  make
  make install

  if [[ ! -f "$package_path/lib/php.ini" ]]; then
    cp php.ini-production $package_path/lib/php.ini
    sed -i 's|;cgi.fix_pathinfo=1|cgi.fix_pathinfo=0|' $package_path/lib/php.ini
    sed -i 's|expose_php = On|expose_php = Off|' $package_path/lib/php.ini
  fi
  if [[ ! -f "$package_path/etc/php-fpm.conf" ]]; then
    cp $package_path/etc/php-fpm.conf.default $package_path/etc/php-fpm.conf
  fi
  if [[ ! -f "$package_path/etc/php-fpm.d/www.conf" ]]; then
    cp $package_path/etc/php-fpm.d/www.conf.default \
      $package_path/etc/php-fpm.d/www.conf
  fi
fi

if [[ $installed == 1 ]]; then
  [[ -e $HOME/.bin/php ]]  || ln -s $package_path/bin/php $HOME/.bin/php
  [[ -e $HOME/.bin/phar ]] || ln -s $package_path/bin/phar $HOME/.bin/phar
fi

exit 0
