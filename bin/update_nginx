#!/bin/bash

set -e

if [[ $1 == 'wordpress' ]]; then
  wordpress_support=1
else
  wordpress_support=0
fi

src_path=$HOME/src
package_path=$HOME/nginx

[[ -d "$src_path" ]] || mkdir -p $src_path

package_url="http://nginx.org$(
  curl -s http://nginx.org/en/download.html | grep .tar.gz \
  | grep -oP '/download/nginx.+?.tar.gz' | head -1
)"

package_archive=$(echo ${package_url##*/})
package_version=$(echo $package_archive | cut -d . -f -3 | cut -d - -f 2)
echo "Latest version is $package_version"

if [[ -x "$package_path/sbin/nginx" ]]; then
  installed=1
  installed_version=$($package_path/sbin/nginx -v 2>&1 | cut -d "/" -f 2)
  configure_options=$(2>&1 $package_path/sbin/nginx -V | grep configure | \
    cut -d " " -f 3-)
  echo "Installed version is $installed_version"
else
  installed=0
  configure_options="--prefix=$package_path --with-http_ssl_module \
    --with-http_gzip_static_module"
  echo "Not installed"

  nps_version='1.12.34.1'
  mod_package_url="https://github.com/pagespeed/ngx_pagespeed/archive/v${nps_version}-beta.tar.gz"
  mod_package_archive="v${nps_version}-beta.tar.gz"
  wget $mod_package_url -O $src_path/$mod_package_archive
  tar -xf $src_path/$mod_package_archive -C $src_path
  configure_options="$configure_options \
    --add-module=$src_path/ngx_pagespeed-$nps_version-beta"
  
<<<<<<< HEAD
  psol_url="https://dl.google.com/dl/page-speed/psol/${nps_version}-x64.tar.gz"
  psol_archive=$(echo ${psol_url##*/})
  wget $psol_url -O $src_path/ngx_pagespeed-$nps_version-beta/$psol_archive
  tar -xf $src_path/ngx_pagespeed-$nps_version-beta/$psol_archive \
    -C $src_path/ngx_pagespeed-$nps_version-beta

=======
  echo "Checking required packages..."
  su -c "apt install gcc make libpcre3-dev libssl-dev"
  
>>>>>>> b7bf019e00f5e0c01902c728028cb56ea50ddbb2
  if [[ $wordpress_support == 1 ]]; then
    mod_package_url='http://labs.frickle.com/files/ngx_cache_purge-2.3.tar.gz'
    mod_package_archive=$(echo ${mod_package_url##*/})
    wget $mod_package_url -O $src_path/$mod_package_archive
    tar -xf $src_path/$mod_package_archive -C $src_path
    configure_options="$configure_options \
      --add-module=$src_path/ngx_cache_purge-2.3"
  fi
fi

if [[ $installed == 0 ]] || [[ $package_version != $installed_version ]]; then
  echo "Updating..."
  if [[ ! -d "$src_path/nginx-$package_version" ]]; then
    if [[ ! -f "$src_path/$package_archive" ]]; then
      wget $package_url -O $src_path/$package_archive
    fi
    tar -xf $src_path/$package_archive -C $src_path
  fi

  cd $src_path/nginx-$package_version
  ./configure $configure_options
  make
  make install
fi

exit 0
