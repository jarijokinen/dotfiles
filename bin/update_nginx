#!/bin/bash

set -e
 
required_packages='gcc make g++ libcurl4-openssl-dev libxml2-dev zlib1g-dev \
  libjpeg-dev libmcrypt-dev libpng-dev libssl-dev pkg-config libpcre3-dev'
nps_version='1.12.34.1'
src_path=$HOME/src
package_path=$HOME/nginx

[[ -d "$src_path" ]] || mkdir -p $src_path

package_url="http://nginx.org$(
  curl -s http://nginx.org/en/download.html | grep .tar.gz \
  | grep -oP '/download/nginx.+?.tar.gz' | head -1
)"

package_archive=$(echo ${package_url##*/})
package_version=$(echo $package_archive | cut -d . -f -3 | cut -d - -f 2)
echo "Latest version is $package_version"

if [[ -x "$package_path/sbin/nginx" ]]; then
  installed=1
  installed_version=$($package_path/sbin/nginx -v 2>&1 | cut -d "/" -f 2)
  configure_options=$(2>&1 $package_path/sbin/nginx -V | grep configure | \
    cut -d " " -f 3-)
  echo "Installed version is $installed_version"
else
  installed=0
  configure_options="--prefix=$package_path --with-http_ssl_module \
    --with-http_gzip_static_module \
    --add-module=$src_path/ngx_pagespeed-$nps_version-beta \
    --add-module=$src_path/ngx_cache_purge-2.3"
  echo "Not installed"
  
  echo "Install required packages..."
  su -c "apt install $required_packages"

  # Install ngx_pagespeed

  nps_package_url="https://github.com/pagespeed/ngx_pagespeed/archive/v${nps_version}-beta.tar.gz"
  nps_package_archive="v${nps_version}-beta.tar.gz"
  wget $nps_package_url -O $src_path/$nps_package_archive
  tar -xf $src_path/$nps_package_archive -C $src_path
  psol_url="https://dl.google.com/dl/page-speed/psol/${nps_version}-x64.tar.gz"
  psol_archive=$(echo ${psol_url##*/})
  wget $psol_url -O $src_path/ngx_pagespeed-$nps_version-beta/$psol_archive
  tar -xf $src_path/ngx_pagespeed-$nps_version-beta/$psol_archive \
    -C $src_path/ngx_pagespeed-$nps_version-beta
  
  # Install ngx_cache_purge
  
  ngxc_package_url='http://labs.frickle.com/files/ngx_cache_purge-2.3.tar.gz'
  ngxc_package_archive=$(echo ${ngxc_package_url##*/})
  wget $ngxc_package_url -O $src_path/$ngxc_package_archive
  tar -xf $src_path/$ngxc_package_archive -C $src_path
fi

if [[ $installed == 0 ]] || [[ $package_version != $installed_version ]]; then
  echo "Updating..."
  if [[ ! -d "$src_path/nginx-$package_version" ]]; then
    if [[ ! -f "$src_path/$package_archive" ]]; then
      wget $package_url -O $src_path/$package_archive
    fi
    tar -xf $src_path/$package_archive -C $src_path
  fi

  cd $src_path/nginx-$package_version
  ./configure $configure_options
  make
  make install
fi

exit 0
